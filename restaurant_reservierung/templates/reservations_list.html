{% extends "base.html" %}

{% block title %}Reservierungsliste{% endblock %}
{% block page_header_title %}{{ page_title }}{% endblock %}

{% block content %}
<style>
    .tab-navigation { display: flex; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
    .tab-button { padding: 10px 20px; cursor: pointer; background: none; border: none; font-size: 1.1em; font-weight: bold; color: #7f8c8d; position: relative; transition: color 0.3s; }
    .tab-button:hover { color: #2c3e50; background-color: #f9f9f9; }
    .tab-button.active { color: #2c3e50; }
    .tab-button.active::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 3px; background-color: #3498db; }
    .tab-content { display: none; animation: fadeIn 0.3s; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .count-badge { background-color: #e74c3c; color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 10px; vertical-align: super; margin-left: 2px; }
</style>

<div class="filter-controls">
    <form method="GET" action="{{ url_for('reservations_list_page') }}" style="display:flex; align-items:center; gap:10px;">
        <label>Datum: <input type="date" name="filter_date" value="{{ active_filter_date }}" min="{{ min_filter_date }}" onchange="this.form.submit()"></label>

        <!-- ID hinzugefügt für JS Zugriff -->
        <label id="shiftFilterContainer">Schicht: <select name="shift" onchange="this.form.submit()">
            {% for s in available_shifts %}
            <option value="{{ s }}" {% if s == current_filter_shift %}selected{% endif %}>{{ s|capitalize }}</option>
            {% endfor %}
        </select></label>

        <a href="{{ url_for('reservations_list_page', filter_date='', shift=current_filter_shift) }}" class="button button-secondary">Alle anzeigen</a>
    </form>
</div>

<div class="tab-navigation">
    <button class="tab-button active" onclick="switchTab('tables')">
        Tisch-Reservierungen {% if reservations_tables|length > 0 %}<span class="count-badge">{{ reservations_tables|length }}</span>{% endif %}
    </button>
    <button class="tab-button" onclick="switchTab('rooms')">
        Zimmer-Reservierungen {% if reservations_rooms|length > 0 %}<span class="count-badge">{{ reservations_rooms|length }}</span>{% endif %}
    </button>
</div>

<!-- TAB 1: TISCHE (Standard Spalten) -->
<div id="content-tables" class="tab-content active">
    {% if reservations_tables and reservations_tables|length > 0 %}
        <table class="reservations-table">
            <thead>
                <tr>
                    <th>Name</th><th>Tisch</th><th>Datum</th><th>Zeit</th><th>Pers.</th><th>Info</th><th>Status</th><th>Aktionen</th>
                </tr>
            </thead>
            <tbody>
                {% for r in reservations_tables %}
                    {% include '_reservation_row_snippet.html' %}
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="no-reservations">Keine Tisch-Reservierungen für die Auswahl gefunden.</p>
    {% endif %}
</div>

<!-- TAB 2: ZIMMER (Neue Spalten) -->
<div id="content-rooms" class="tab-content">
    {% if reservations_rooms and reservations_rooms|length > 0 %}
        <table class="reservations-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Zimmer</th>
                    <th>Anreise</th> <!-- Kombiniert Datum + Zeit -->
                    <th>Abreise</th> <!-- Kombiniert Enddatum + Zeit -->
                    <th>Pers.</th>
                    <th>Info</th>
                    <th>Status</th>
                    <th>Aktionen</th>
                </tr>
            </thead>
            <tbody>
                {% for r in reservations_rooms %}
                <tr class="reservation-row {{ 'guest-arrived' if r.arrived and not r.departed else '' }}">
                    <td>{{ r.name }}</td>
                    <td>{{ r.table_display_name }}</td>

                    <!-- Anreise Spalte -->
                    <td style="font-weight:bold;">
                        {{ r.display_date }}<br>
                        <small>{{ r.time }} Uhr</small>
                    </td>

                    <!-- Abreise Spalte -->
                    <td>
                        {{ r.display_end_date }}<br>
                        <small>{{ r.checkout_time }} Uhr</small>
                    </td>

                    <td>{{ r.persons }}</td>
                    <td>{{ r.info }}</td>
                    <td>
                        {% if r.departed %}
                            <span style="color:grey; font-style:italic;">Abgereist</span>
                        {% elif r.arrived %}
                            <span style="color:green; font-weight:bold;">Eingecheckt</span>
                        {% else %}
                            <span style="color:#7f8c8d;">Gebucht</span>
                        {% endif %}
                    </td>
                    <td class="actions-cell">
                        <a href="{{ url_for('edit_reservation_page', reservation_id=r.id) }}" class="button button-edit">Edit</a>
                        <button class="button button-delete" onclick="deleteReservationPrompt_listPage('{{ r.id }}', '{{ r.table_display_name }}', '{{ r.name }}', '{{ r.display_date }}')">Löschen</button>

                        {% if not r.departed %}
                            {% if not r.arrived %}
                            <button class="button button-arrival pending-arrival"
                                    onclick="fetch('/api/reservierung_angekommen/{{r.id}}', {method:'POST'}).then(()=>location.reload())">
                                Check-In
                            </button>
                            {% else %}
                            <button class="button button-mark-departed"
                                    onclick="fetch('/api/reservierung_gegangen/{{r.id}}', {method:'POST'}).then(()=>location.reload())">
                                Check-Out
                            </button>
                            {% endif %}
                        {% else %}
                            <button class="button" disabled style="background:#ccc;">Erledigt</button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="no-reservations">Keine Zimmer-Reservierungen für die Auswahl gefunden.</p>
    {% endif %}
</div>

{% include '_modals.html' ignore missing %} <!-- Falls du Modals ausgelagert hast, sonst hier lassen -->
<div id="deleteConfirmationModal" class="modal-overlay">
    <div class="modal-content">
        <h3>Reservierung löschen</h3>
        <p id="deleteModalMessageText">Wirklich löschen?</p>
        <div class="modal-actions">
            <button id="confirmDeleteBtn" class="button button-delete">Löschen</button>
            <button id="cancelDeleteBtn" class="button button-cancel">Abbrechen</button>
        </div>
    </div>
</div>

{% endblock %}

{% block bottom_scripts %}
    {{ super() }}
    <script>
        // Tab Logik + Shift Toggle
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById('content-' + tabName).classList.add('active');

            const buttons = document.querySelectorAll('.tab-button');
            if(tabName === 'tables') {
                buttons[0].classList.add('active');
                // Tische -> Schicht anzeigen
                document.getElementById('shiftFilterContainer').style.display = 'inline-block';
            }
            if(tabName === 'rooms') {
                buttons[1].classList.add('active');
                // Zimmer -> Schicht verbergen
                document.getElementById('shiftFilterContainer').style.display = 'none';
            }
        }

        // Initiale Prüfung beim Laden
        document.addEventListener('DOMContentLoaded', function() {
            // Standard ist Tables aktiv, also Shift sichtbar.
            // Falls man Logik will, um den letzten Tab zu merken, müsste man das hier tun.
        });

        // Lösch Logik (Kopie oder Referenz)
        let currentDeleteId = null;
        const delModal = document.getElementById('deleteConfirmationModal');
        function deleteReservationPrompt_listPage(id, table, name, date) {
            currentDeleteId = id;
            if(delModal) {
                document.getElementById('deleteModalMessageText').innerText = `Reservierung für ${name} löschen?`;
                delModal.classList.add('active');
            } else if(confirm("Löschen?")) performDelete(id);
        }
        if(document.getElementById('confirmDeleteBtn')) document.getElementById('confirmDeleteBtn').onclick = () => performDelete(currentDeleteId);
        if(document.getElementById('cancelDeleteBtn')) document.getElementById('cancelDeleteBtn').onclick = () => delModal.classList.remove('active');

        function performDelete(id) {
            fetch('/api/reservierung_loeschen/' + id, {method: 'DELETE'})
            .then(r => r.json()).then(d => { if(d.success) window.location.reload(); else alert("Fehler"); });
        }
    </script>
{% endblock %}