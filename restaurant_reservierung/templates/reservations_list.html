{% extends "base.html" %}

{% block title %}Reservierungsliste{% endblock %}
{% block page_header_title %}{{ page_title }}{% endblock %}

{% block content %}
<style>
    .tab-navigation { display: flex; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
    .tab-button { padding: 10px 20px; cursor: pointer; background: none; border: none; font-size: 1.1em; font-weight: bold; color: #7f8c8d; position: relative; transition: color 0.3s; }
    .tab-button:hover { color: #2c3e50; background-color: #f9f9f9; }
    .tab-button.active { color: #2c3e50; }
    .tab-button.active::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 3px; background-color: #3498db; }
    .tab-content { display: none; animation: fadeIn 0.3s; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .count-badge { background-color: #e74c3c; color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 10px; vertical-align: super; margin-left: 2px; }
</style>

<div class="filter-controls">
    <form method="GET" action="{{ url_for('reservations_list_page') }}" style="display:flex; align-items:center; gap:10px;">
        <label>Datum: <input type="date" name="filter_date" value="{{ active_filter_date }}" min="{{ min_filter_date }}" onchange="this.form.submit()"></label>

        <!-- ID hinzugefügt für JS Zugriff -->
        <label id="shiftFilterContainer">Schicht: <select name="shift" onchange="this.form.submit()">
            {% for s in available_shifts %}
            <option value="{{ s }}" {% if s == current_filter_shift %}selected{% endif %}>{{ s|capitalize }}</option>
            {% endfor %}
        </select></label>

        <a href="{{ url_for('reservations_list_page', filter_date='', shift=current_filter_shift) }}" class="button button-secondary">Alle anzeigen</a>
    </form>
</div>

<div class="tab-navigation">
    <button class="tab-button active" onclick="switchTab('tables')">
        Tisch-Reservierungen {% if reservations_tables|length > 0 %}<span class="count-badge">{{ reservations_tables|length }}</span>{% endif %}
    </button>
    <button class="tab-button" onclick="switchTab('rooms')">
        Zimmer-Reservierungen {% if reservations_rooms|length > 0 %}<span class="count-badge">{{ reservations_rooms|length }}</span>{% endif %}
    </button>
</div>

<!-- TAB 1: TISCHE (Standard Spalten) -->
<div id="content-tables" class="tab-content active">
    {% if reservations_tables and reservations_tables|length > 0 %}
        <table class="reservations-table">
            <thead>
                <tr>
                    <th>Name</th><th>Tisch</th><th>Datum</th><th>Zeit</th><th>Pers.</th><th>Info</th><th>Status</th><th>Aktionen</th>
                </tr>
            </thead>
            <tbody>
                {% for r in reservations_tables %}
                    {% include '_reservation_row_snippet.html' %}
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="no-reservations">Keine Tisch-Reservierungen für die Auswahl gefunden.</p>
    {% endif %}
</div>

<!-- TAB 2: ZIMMER (Neue Spalten) -->
<div id="content-rooms" class="tab-content">
    {% if reservations_rooms and reservations_rooms|length > 0 %}
        <table class="reservations-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Zimmer</th>
                    <th>Anreise</th> <!-- Kombiniert Datum + Zeit -->
                    <th>Abreise</th> <!-- Kombiniert Enddatum + Zeit -->
                    <th>Pers.</th>
                    <th>Info</th>
                    <th>Status</th>
                    <th>Aktionen</th>
                </tr>
            </thead>
            <tbody>
                {% for r in reservations_rooms %}
                <tr class="reservation-row {{ 'guest-arrived' if r.arrived and not r.departed else '' }}">
                    <td>{{ r.name }}</td>
                    <td>{{ r.table_display_name }}</td>

                    <!-- Anreise Spalte -->
                    <td style="font-weight:bold;">
                        {{ r.display_date }}<br>
                        <small>{{ r.time }} Uhr</small>
                    </td>

                    <!-- Abreise Spalte -->
                    <td>
                        {{ r.display_end_date }}<br>
                        <small>{{ r.checkout_time }} Uhr</small>
                    </td>

                    <td>{{ r.persons }}</td>
                    <td>{{ r.info }}</td>
                    <td>
                        {% if r.departed %}
                            <span style="color:grey; font-style:italic;">Abgereist</span>
                        {% elif r.arrived %}
                            <span style="color:green; font-weight:bold;">Eingecheckt</span>
                        {% else %}
                            <span style="color:#7f8c8d;">Gebucht</span>
                        {% endif %}
                    </td>
                    <td class="actions-cell">
                        <a href="{{ url_for('edit_reservation_page', reservation_id=r.id) }}" class="button button-edit">Edit</a>
                        <button class="button button-delete" onclick="deleteReservationPrompt_listPage('{{ r.id }}', '{{ r.table_display_name }}', '{{ r.name }}', '{{ r.display_date }}')">Löschen</button>

                        {% if not r.departed %}
                            {% if not r.arrived %}
                            <button class="button button-arrival pending-arrival"
                                    onclick="fetch('/api/reservierung_angekommen/{{r.id}}', {method:'POST'}).then(()=>location.reload())">
                                Check-In
                            </button>
                            {% else %}
                            <button class="button button-mark-departed"
                                    onclick="fetch('/api/reservierung_gegangen/{{r.id}}', {method:'POST'}).then(()=>location.reload())">
                                Check-Out
                            </button>
                            {% endif %}
                        {% else %}
                            <button class="button" disabled style="background:#ccc;">Erledigt</button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="no-reservations">Keine Zimmer-Reservierungen für die Auswahl gefunden.</p>
    {% endif %}
</div>

<!-- ========================================================== -->
<!-- PRÜFE, OB DIESES HTML FÜR DAS VERSCHIEBEN-MODAL EXISTIERT -->
<!-- ========================================================== -->

<div id="moveReservationModal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-button" onclick="closeMoveReservationModal_listPage()">×</button>

        <h3>Reservierung verschieben</h3>

        <p>Wählen Sie einen neuen Tisch für:
            <strong id="moveReservationGuestName"></strong>
            (<span id="moveReservationDetails"></span>)
        </p>

        <div id="availableTablesForMoveList" style="margin-top: 15px; max-height: 300px; overflow-y: auto; border: 1px solid #eee; padding: 10px;">
            <!-- Inhalt wird per JavaScript geladen -->
        </div>

        <div class="modal-actions" style="margin-top: 20px;">
            <button onclick="closeMoveReservationModal_listPage()" class="button button-cancel">Abbrechen</button>
        </div>
    </div>
</div>

{% include '_modals.html' ignore missing %} <!-- Falls du Modals ausgelagert hast, sonst hier lassen -->
<div id="deleteConfirmationModal" class="modal-overlay">
    <div class="modal-content">
        <h3>Reservierung löschen</h3>
        <p id="deleteModalMessageText">Wirklich löschen?</p>
        <div class="modal-actions">
            <button id="confirmDeleteBtn" class="button button-delete">Löschen</button>
            <button id="cancelDeleteBtn" class="button button-cancel">Abbrechen</button>
        </div>
    </div>
</div>

{% endblock %}


{% block bottom_scripts %}
    {{ super() }}
    <script>
        // =================================================================
        // VARIABLEN NUR FÜR DIESE SEITE (mit "_listPage" umbenannt, um Konflikte zu vermeiden)
        // =================================================================
        let deleteId_listPage = null;
        let moveId_listPage = null;
        const confirmationModal_listPage = document.getElementById('deleteConfirmationModal');


        // =================================================================
        // TEIL 1: TAB-LOGIK
        // =================================================================
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById('content-' + tabName).classList.add('active');

            const buttons = document.querySelectorAll('.tab-button');
            if (tabName === 'tables') {
                buttons[0].classList.add('active');
                const shiftFilter = document.getElementById('shiftFilterContainer');
                if(shiftFilter) shiftFilter.style.display = 'inline-block';
            }
            if (tabName === 'rooms') {
                buttons[1].classList.add('active');
                const shiftFilter = document.getElementById('shiftFilterContainer');
                if(shiftFilter) shiftFilter.style.display = 'none';
            }
        }


        // =================================================================
        // TEIL 2: LÖSCH-LOGIK
        // =================================================================
        function deleteReservationPrompt_listPage(id, table, name, date) {
            deleteId_listPage = id; // Benutzt die umbenannte Variable
            if (confirmationModal_listPage) {
                const modalText = document.getElementById('deleteModalMessageText');
                if(modalText) modalText.innerText = `Reservierung für ${name} löschen?`;
                confirmationModal_listPage.classList.add('active');
            } else if (confirm("Löschen?")) {
                performDelete_listPage(id);
            }
        }

        if (document.getElementById('confirmDeleteBtn')) {
            document.getElementById('confirmDeleteBtn').onclick = () => performDelete_listPage(deleteId_listPage);
        }
        if (document.getElementById('cancelDeleteBtn')) {
            document.getElementById('cancelDeleteBtn').onclick = () => confirmationModal_listPage.classList.remove('active');
        }

        function performDelete_listPage(id) {
            fetch('/api/reservierung_loeschen/' + id, { method: 'DELETE' })
                .then(r => r.json()).then(d => {
                    if (d.success) window.location.reload();
                    else alert("Fehler beim Löschen.");
                });
        }


        // =================================================================
        // TEIL 3: VERSCHIEBEN-LOGIK
        // =================================================================
        function closeMoveReservationModal_listPage() {
            const moveModal = document.getElementById('moveReservationModal');
            if (moveModal) moveModal.classList.remove('active');
        }

        function openMoveReservationModal_listPage(reservationId, guestName, resDate, resTime, resPersons) {
            moveId_listPage = reservationId; // Benutzt die umbenannte Variable

            const moveModal = document.getElementById('moveReservationModal');
            if (!moveModal) return;

            const guestNameSpan = document.getElementById('moveReservationGuestName');
            const detailsSpan = document.getElementById('moveReservationDetails');
            const availableListDiv = document.getElementById('availableTablesForMoveList');

            if (guestNameSpan) guestNameSpan.textContent = guestName;
            if (detailsSpan) detailsSpan.textContent = `für ${resPersons} Pers. am ${resDate} um ${resTime}`;
            if (availableListDiv) availableListDiv.innerHTML = '<p>Verfügbare Tische werden geladen...</p>';

            moveModal.classList.add('active');

            fetch(`/api/available_tables_for_move/${reservationId}`)
                .then(response => response.json())
                .then(data => {
                    renderAvailableTables_listPage(data.available_tables || []);
                })
                .catch(error => {
                    if (availableListDiv) availableListDiv.innerHTML = `<p>Fehler beim Laden: ${error.message}</p>`;
                });
        }

        function renderAvailableTables_listPage(tables) {
            const availableListDiv = document.getElementById('availableTablesForMoveList');
            if (!availableListDiv) return;

            availableListDiv.innerHTML = '';
            if (tables.length === 0) {
                availableListDiv.innerHTML = '<p>Keine freien Tische zum Verschieben gefunden.</p>';
                return;
            }
            tables.forEach(table => {
                const tableItem = document.createElement('div');
                tableItem.className = 'available-table-item';
                tableItem.style.cursor = 'pointer';
                tableItem.innerHTML = `<strong>${table.display_name}</strong>`;
                tableItem.onclick = () => executeMoveOnServer_listPage(moveId_listPage, table.id); // Benutzt die umbenannte Variable
                availableListDiv.appendChild(tableItem);
            });
        }

        function executeMoveOnServer_listPage(reservationId, newTableId) {
            fetch(`/api/move_reservation/${reservationId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ new_table_id: newTableId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Erfolgreich verschoben!');
                    window.location.reload();
                } else {
                    alert('Fehler: ' + data.message);
                }
            });
        }
    </script>
{% endblock bottom_scripts %}